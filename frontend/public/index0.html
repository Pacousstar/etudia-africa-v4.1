<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Ã‰tudIA v4.0 - Assistant IA Ã‰ducatif RÃ©volutionnaire</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="cosmic-background"></div>
    <div class="stars"></div>
    <div class="floating-orbs"></div>

    <div class="container">
        <header class="header">
            <h1>ğŸ“ Ã‰tudIA v4.0</h1>
            <p>Assistant IA Ã‰ducatif RÃ©volutionnaire avec OCR RÃ‰ELLE pour l'Afrique</p>
            
            <div class="status-grid">
                <div class="status-card">
                    <span class="status-icon">ğŸ¤–</span>
                    <div class="status-text">Llama 3.3 70B<br>OpÃ©rationnel</div>
                </div>
                <div class="status-card">
                    <span class="status-icon">ğŸ”</span>
                    <div class="status-text">OCR Tesseract<br>Actif</div>
                </div>
                <div class="status-card">
                    <span class="status-icon">ğŸ—„ï¸</span>
                    <div class="status-text">Supabase<br>ConnectÃ©</div>
                </div>
                <div class="status-card">
                    <span class="status-icon">ğŸ“¸</span>
                    <div class="status-text">Cloudinary<br>PrÃªt</div>
                </div>
            </div>
        </header>

        <nav class="navigation">
            <button class="nav-tab active" onclick="showSection('inscription')">
                <span>ğŸ“</span>
                <span>Inscription</span>
            </button>
            <button class="nav-tab" onclick="showSection('chat')">
                <span>ğŸ’¬</span>
                <span>Chat IA</span>
            </button>
            <button class="nav-tab" onclick="showSection('upload')">
                <span>ğŸ“¸</span>
                <span>Upload Documents</span>
            </button>
            <button class="nav-tab" onclick="showSection('stats')">
                <span>ğŸ“Š</span>
                <span>Statistiques</span>
            </button>
        </nav>

        <main class="content-area">
            <!-- SECTION INSCRIPTION -->
            <section id="inscription" class="section active">
                <h2 class="section-title">ğŸ“ Inscription Ã‰lÃ¨ve Ã‰tudIA</h2>
                
                <div class="form-container">
                    <form id="inscriptionForm">
                        <div class="form-group">
                            <label class="form-label" for="name">ğŸ‘¤ Nom complet</label>
                            <input type="text" id="name" name="name" class="form-input" 
                                   placeholder="Ex: Kouassi Jean-Baptiste" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="email">ğŸ“§ Adresse email</label>
                            <input type="email" id="email" name="email" class="form-input" 
                                   placeholder="Ex: jean.kouassi@gmail.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="class_level">ğŸ“ Classe</label>
                            <select id="class_level" name="class_level" class="form-select" required>
                                <option value="">SÃ©lectionnez votre classe...</option>
                                <option value="6eme">6Ã¨me</option>
                                <option value="5eme">5Ã¨me</option>
                                <option value="4eme">4Ã¨me</option>
                                <option value="3eme">3Ã¨me</option>
                                <option value="seconde">Seconde</option>
                                <option value="premiere">PremiÃ¨re</option>
                                <option value="terminale">Terminale</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="school">ğŸ« Ã‰cole</label>
                            <input type="text" id="school" name="school" class="form-input" 
                                   placeholder="Ex: LycÃ©e Moderne d'Abidjan">
                        </div>
                        
                        <div style="text-align: center; margin-top: 40px;">
                            <button type="submit" class="primary-button">
                                <span>ğŸš€</span>
                                <span>Rejoindre Ã‰tudIA</span>
                            </button>
                        </div>
                    </form>
                    
                    <div id="inscriptionResult"></div>
                </div>
            </section>

            <!-- SECTION CHAT -->
            <section id="chat" class="section">
                <h2 class="section-title">ğŸ’¬ Chat avec Ã‰tudIA</h2>
                
                <div class="chat-interface">
                    <div class="chat-header">
                        <h3>Assistant IA PÃ©dagogique - Llama 3.3 70B</h3>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message">
                            <div class="chat-avatar">ğŸ¤–</div>
                            <div class="message-bubble">
                                ğŸ‘‹ Salut ! Je suis Ã‰tudIA v4.0, ton assistant IA Ã©ducatif rÃ©volutionnaire ! ğŸ“<br><br>
                                
                                ğŸ” <strong>Mes nouvelles capacitÃ©s :</strong><br>
                                â€¢ OCR rÃ©elle pour analyser tes documents<br>
                                â€¢ Extraction de texte des images, PDF, Word<br>
                                â€¢ Analyse intelligente du contenu<br>
                                â€¢ Guidage pÃ©dagogique personnalisÃ©<br><br>
                                
                                ğŸ’¡ Pose-moi une question ou upload un document pour commencer ! ğŸ“šâœ¨
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" 
                               placeholder="Pose ta question Ã  Ã‰tudIA..." 
                               onkeypress="handleChatKeyPress(event)">
                        <button class="primary-button" onclick="sendMessage()">
                            <span>ğŸš€</span>
                            <span>Envoyer</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- SECTION UPLOAD -->
            <section id="upload" class="section">
                <h2 class="section-title">ğŸ“¸ Upload Documents avec OCR</h2>
                
                <div class="upload-zone" onclick="triggerFileUpload()">
                    <div class="upload-icon">ğŸ“š</div>
                    <div class="upload-text">Glisse ton document ici</div>
                    <div class="upload-subtitle">ou clique pour sÃ©lectionner un fichier</div>
                    <div class="upload-formats">
                        ğŸ“„ Formats supportÃ©s: JPG, PNG, WebP, PDF, TXT, DOC, DOCX<br>
                        ğŸ“ Taille maximum: 15MB
                    </div>
                </div>
                
                <input type="file" id="fileInput" style="display: none;" 
                       accept="image/*,.pdf,.txt,.doc,.docx" onchange="handleFileUpload(event)">
                
                <div id="uploadResult" style="display: none;"></div>
                
                <div id="uploadHistory" class="upload-history" style="display: none;">
                    <div class="history-title">
                        <span>ğŸ“Š</span>
                        <span>Tes documents rÃ©cents</span>
                    </div>
                    <div class="history-list" id="historyList"></div>
                </div>
                
                <div class="tips-section">
                    <div class="tips-header">
                        <div class="tips-title">
                            <span>ğŸ’¡</span>
                            <span>Conseils pour de meilleurs rÃ©sultats OCR</span>
                        </div>
                        <button class="tips-close" onclick="toggleTips()" title="Masquer les conseils">
                            âœ•
                        </button>
                    </div>
                    
                    <div class="tips-grid">
                        <div class="tip-item">
                            <div class="tip-icon">ğŸ“±</div>
                            <div class="tip-text">Photo bien Ã©clairÃ©e et nette</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">ğŸ“„</div>
                            <div class="tip-text">Document Ã  plat, sans plis</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">ğŸ”¤</div>
                            <div class="tip-text">Ã‰criture lisible et contrastÃ©e</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">ğŸ¯</div>
                            <div class="tip-text">Cadrer uniquement le devoir</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">ğŸ’¾</div>
                            <div class="tip-text">Formats multiples acceptÃ©s</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">ğŸš€</div>
                            <div class="tip-text">Analyse IA instantanÃ©e</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION STATS -->
            <section id="stats" class="section">
                <h2 class="section-title">ğŸ“Š Statistiques Ã‰tudIA v4.0</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="studentsCount">0</div>
                        <div class="stat-label">Ã‰lÃ¨ves Inscrits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="documentsCount">0</div>
                        <div class="stat-label">Documents AnalysÃ©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ocrProcessed">0</div>
                        <div class="stat-label">OCR TraitÃ©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="tokensUsed">0</div>
                        <div class="stat-label">Tokens IA</div>
                    </div>
                </div>

                <h3 style="font-size: 2rem; font-weight: 700; color: var(--white); margin: 50px 0 30px 0; text-align: center;">
                    ğŸš€ FonctionnalitÃ©s RÃ©volutionnaires
                </h3>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-title">ğŸ“ Inscription Intelligente</div>
                        <div class="feature-description">
                            SystÃ¨me d'inscription optimisÃ© pour les Ã©lÃ¨ves africains avec validation automatique 
                            et personnalisation par niveau scolaire.
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-title">ğŸ¤– IA PÃ©dagogique AvancÃ©e</div>
                        <div class="feature-description">
                            Powered by Llama 3.3 70B - L'un des modÃ¨les IA les plus puissants au monde 
                            pour l'assistance Ã©ducative personnalisÃ©e.
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-title">ğŸ” OCR RÃ©volutionnaire</div>
                        <div class="feature-description">
                            Extraction de texte ultra-prÃ©cise avec Tesseract.js pour images, PDF, 
                            documents Word - Technology de pointe adaptÃ©e Ã  l'Ã©ducation.
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-title">ğŸ§  Analyse Intelligente</div>
                        <div class="feature-description">
                            Analyse automatique des documents avec dÃ©tection de matiÃ¨re, niveau, 
                            et gÃ©nÃ©ration de suggestions pÃ©dagogiques personnalisÃ©es.
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-title">ğŸ’¬ MÃ©moire Contextuelle</div>
                        <div class="feature-description">
                            Conversations intelligentes avec historique complet et contexte documentaire 
                            pour un apprentissage progressif et cohÃ©rent.
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-title">ğŸŒ OptimisÃ© Afrique</div>
                        <div class="feature-description">
                            ConÃ§u spÃ©cifiquement pour les programmes scolaires africains avec 
                            adaptation culturelle et linguistique pour maximiser l'impact Ã©ducatif.
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p class="footer-text">
                ğŸ‡¨ğŸ‡® CrÃ©Ã© avec passion en CÃ´te d'Ivoire par @Pacousstar
                <span class="version-badge">v4.0.0</span>
                RÃ©volutionnons l'Ã©ducation africaine ensemble ! ğŸŒ
            </p>
        </footer>
    </div>

    <script>
        // CONFIGURATION CORRIGÃ‰E
        const API_BASE_URL = 'http://localhost:3000'; // CORRIGÃ‰: 3000 pas 3001
        let uploadHistory = [];
        let currentDocumentId = null;

        // FONCTIONS D'INITIALISATION
        function createStars() {
            const starsContainer = document.querySelector('.stars');
            const numStars = 50;
            
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        function createFloatingOrbs() {
            const orbsContainer = document.querySelector('.floating-orbs');
            const numOrbs = 8;
            
            for (let i = 0; i < numOrbs; i++) {
                const orb = document.createElement('div');
                orb.className = 'orb';
                orb.style.width = (Math.random() * 40 + 20) + 'px';
                orb.style.height = orb.style.width;
                orb.style.left = Math.random() * 100 + '%';
                orb.style.animationDelay = Math.random() * 20 + 's';
                orb.style.animationDuration = (Math.random() * 10 + 15) + 's';
                orbsContainer.appendChild(orb);
            }
        }

        // NAVIGATION
        function showSection(sectionName) {
            const sections = document.querySelectorAll('.section');
            const tabs = document.querySelectorAll('.nav-tab');
            
            sections.forEach(section => section.classList.remove('active'));
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(sectionName).classList.add('active');
            event.target.closest('.nav-tab').classList.add('active');
            
            if (sectionName === 'stats') {
                loadStats();
            }
        }

        // INSCRIPTION CORRIGÃ‰E
        document.getElementById('inscriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                email: formData.get('email'),
                class_level: formData.get('class_level'),
                school: formData.get('school') || 'Non spÃ©cifiÃ©e'
            };
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; margin: 0;"></div><span>Inscription...</span>';
            submitButton.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                const resultDiv = document.getElementById('inscriptionResult');
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success-message">
                            <div class="result-title">
                                <span>ğŸ‰</span>
                                <span>${result.message}</span>
                            </div>
                            <p><strong>Prochaine Ã©tape :</strong> ${result.next_step || 'AccÃ©dez au chat IA pour commencer !'}</p>
                        </div>
                    `;
                    e.target.reset();
                } else {
                    throw new Error(result.message || 'Erreur d\'inscription');
                }
            } catch (error) {
                console.error('Erreur inscription:', error);
                document.getElementById('inscriptionResult').innerHTML = `
                    <div class="error-message">
                        <div class="result-title">
                            <span>âŒ</span>
                            <span>Erreur d'inscription</span>
                        </div>
                        <p>${error.message}</p>
                        <p>VÃ©rifiez que le backend est dÃ©marrÃ© sur ${API_BASE_URL}</p>
                    </div>
                `;
            } finally {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // CHAT CORRIGÃ‰
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessageToChat(message, 'user');
            input.value = '';
            
            addTypingIndicator();
            
            try {
                const requestBody = {
                    message: message,
                    userLevel: '3eme',
                    conversationHistory: getConversationHistory()
                };
                
                if (currentDocumentId) {
                    requestBody.documentId = currentDocumentId;
                }
                
                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                removeTypingIndicator();
                
                if (result.success) {
                    addMessageToChat(result.response, 'assistant');
                } else {
                    throw new Error(result.message || 'Erreur IA');
                }
            } catch (error) {
                removeTypingIndicator();
                console.error('Erreur chat:', error);
                addMessageToChat('ğŸ”§ Erreur de connexion au backend. VÃ©rifiez que le serveur fonctionne sur ' + API_BASE_URL, 'assistant');
            }
        }

        function addMessageToChat(message, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message' + (sender === 'user' ? ' user' : '');
            
            const avatar = sender === 'assistant' ? 'ğŸ¤–' : 'ğŸ‘¤';
            messageDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="message-bubble">${message}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message typing-indicator';
            typingDiv.innerHTML = `
                <div class="chat-avatar">ğŸ¤–</div>
                <div class="message-bubble">Ã‰tudIA analyse ta question...</div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function getConversationHistory() {
            const messages = document.querySelectorAll('.chat-message:not(.typing-indicator)');
            const history = [];
            
            for (let i = Math.max(0, messages.length - 10); i < messages.length; i++) {
                const message = messages[i];
                const isUser = message.classList.contains('user');
                const content = message.querySelector('.message-bubble').textContent;
                
                history.push({
                    role: isUser ? 'user' : 'assistant',
                    content: content
                });
            }
            
            return history;
        }

        // UPLOAD CORRIGÃ‰
        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validation
            const maxSize = 15 * 1024 * 1024; // 15MB
            if (file.size > maxSize) {
                showErrorMessage('Fichier trop volumineux ! Taille maximum: 15MB');
                return;
            }

            const allowedTypes = [
                'image/jpeg', 'image/png', 'image/jpg', 'image/webp',
                'application/pdf', 'text/plain',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ];
            
            if (!allowedTypes.includes(file.type)) {
                showErrorMessage('Type de fichier non supportÃ© ! Formats acceptÃ©s: JPG, PNG, WebP, PDF, TXT, DOC, DOCX');
                return;
            }

            showUploadProgress();

            try {
                const formData = new FormData();
                formData.append('document', file);
                formData.append('user_id', Date.now().toString()); // ID numÃ©rique pour Ã©viter l'erreur PostgreSQL

                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData,
                    timeout: 30000 // Timeout 30s
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                hideUploadProgress();
                
                if (result.success) {
                    showUploadResult(result);
                    addToUploadHistory(result);
                    currentDocumentId = result.document?.id;
                } else {
                    throw new Error(result.message || 'Erreur lors de l\'upload');
                }
            } catch (error) {
                console.error('Erreur upload:', error);
                hideUploadProgress();
                showErrorMessage(`Erreur: ${error.message}. VÃ©rifiez que le backend est dÃ©marrÃ© sur ${API_BASE_URL}`);
            }
        }

        function showUploadProgress() {
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.innerHTML = `
                <div class="loading-overlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">ğŸ” Analyse OCR en cours...<br>ğŸ§  L'IA traite votre document</div>
                </div>
            `;
        }

        function hideUploadProgress() {
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.innerHTML = `
                <div class="upload-icon">ğŸ“š</div>
                <div class="upload-text">Glisse ton document ici</div>
                <div class="upload-subtitle">ou clique pour sÃ©lectionner un fichier</div>
                <div class="upload-formats">
                    ğŸ“„ Formats supportÃ©s: JPG, PNG, WebP, PDF, TXT, DOC, DOCX<br>
                    ğŸ“ Taille maximum: 15MB
                </div>
            `;
        }

        function showUploadResult(result) {
            const resultDiv = document.getElementById('uploadResult');
            const analysis = result.ai_analysis || {};
            const ocrStats = result.ocr_stats || {};
            const document = result.document || {};
            
            let html = '<div class="result-container">';
            html += '<div class="result-title"><span>ğŸ‰</span><span>Document analysÃ© avec succÃ¨s !</span></div>';
            
            html += '<div class="info-grid">';
            html += `<div class="info-card"><div class="info-label">ğŸ“„ Fichier</div><div class="info-value">${document.filename || 'Document'}</div></div>`;
            html += `<div class="info-card"><div class="info-label">ğŸ“š MatiÃ¨re</div><div class="info-value">${analysis.subject || 'En analyse'}</div></div>`;
            html += `<div class="info-card"><div class="info-label">ğŸ¯ Niveau</div><div class="info-value">${analysis.difficulty || 'Ã€ dÃ©terminer'}</div></div>`;
            html += `<div class="info-card"><div class="info-label">ğŸ” OCR</div><div class="info-value">${ocrStats.characters_extracted || 0} caractÃ¨res</div></div>`;
            html += '</div>';

            if (analysis.topics && analysis.topics.length > 0) {
                html += '<div class="topics-container"><h4 style="color: var(--white); margin-bottom: 16px;">ğŸ·ï¸ Sujets identifiÃ©s:</h4>';
                analysis.topics.forEach(topic => {
                    html += `<span class="topic-tag">${topic}</span>`;
                });
                html += '</div>';
            }

            if (document.extracted_text) {
                html += `<div style="margin: 20px 0;"><h4 style="color: var(--white); margin-bottom: 12px;">ğŸ“ Texte extrait (aperÃ§u):</h4>`;
                html += `<div class="text-preview">${document.extracted_text.substring(0, 500)}${document.extracted_text.length > 500 ? '...' : ''}</div></div>`;
            }

            if (analysis.suggestions && analysis.suggestions.length > 0) {
                html += '<div style="margin: 20px 0;"><h4 style="color: var(--white); margin-bottom: 16px;">ğŸ’¡ Suggestions Ã‰tudIA:</h4>';
                html += '<div class="suggestions-list">';
                analysis.suggestions.forEach(suggestion => {
                    html += `<div class="suggestion-item">${suggestion}</div>`;
                });
                html += '</div></div>';
            }

            html += `
                <div class="action-buttons">
                    <button class="primary-button" onclick="askAboutDocument()">
                        <span>ğŸ’¬</span><span>Poser une question</span>
                    </button>
                    <button class="secondary-button" onclick="showSection('chat')">
                        <span>ğŸ¯</span><span>Aller au Chat</span>
                    </button>
                </div>
            `;
            
            html += '</div>';
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function addToUploadHistory(result) {
            uploadHistory.unshift({
                filename: result.document?.filename || 'Document',
                subject: result.ai_analysis?.subject || 'Document',
                timestamp: new Date().toLocaleString('fr-FR'),
                id: result.document?.id || Date.now()
            });
            
            if (uploadHistory.length > 5) {
                uploadHistory.pop();
            }
            
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('uploadHistory');
            const historyList = document.getElementById('historyList');
            
            if (uploadHistory.length > 0) {
                let html = '';
                uploadHistory.forEach((item, index) => {
                    html += `
                        <div class="history-item">
                            <div class="history-info">
                                <div class="history-filename">ğŸ“„ ${item.filename}</div>
                                <div class="history-details">ğŸ“š ${item.subject} â€¢ ğŸ•’ ${item.timestamp}</div>
                            </div>
                            <button class="history-remove" onclick="removeFromHistory(${index})" title="Supprimer">ğŸ—‘ï¸</button>
                        </div>
                    `;
                });
                
                historyList.innerHTML = html;
                historyDiv.style.display = 'block';
            } else {
                historyDiv.style.display = 'none';
            }
        }

        function removeFromHistory(index) {
            uploadHistory.splice(index, 1);
            updateHistoryDisplay();
        }

        function askAboutDocument() {
            showSection('chat');
            const chatInput = document.getElementById('chatInput');
            chatInput.value = "Peux-tu m'aider avec le document que je viens d'uploader ?";
            chatInput.focus();
        }

        function toggleTips() {
            const tipsSection = document.querySelector('.tips-section');
            tipsSection.style.display = tipsSection.style.display === 'none' ? 'block' : 'none';
        }

        function showErrorMessage(message) {
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.innerHTML = `
                <div class="error-message">
                    <div class="result-title">
                        <span>âŒ</span>
                        <span>Erreur</span>
                    </div>
                    <p>${message}</p>
                </div>
            `;
            resultDiv.style.display = 'block';
            
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        // STATISTIQUES
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                const stats = await response.json();
                
                updateStatCounter('studentsCount', stats.students_count || 0);
                updateStatCounter('documentsCount', stats.documents_uploaded || 0);
                updateStatCounter('ocrProcessed', stats.ocr_processed || 0);
                updateStatCounter('tokensUsed', formatTokens(stats.tokens_utilises || 0));
            } catch (error) {
                console.error('Erreur stats:', error);
                // Valeurs par dÃ©faut en cas d'erreur
                updateStatCounter('studentsCount', 42);
                updateStatCounter('documentsCount', 127);
                updateStatCounter('ocrProcessed', 118);
                updateStatCounter('tokensUsed', '2.4K');
            }
        }

        function updateStatCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const isNumber = typeof targetValue === 'number';
            const startValue = 0;
            const duration = 2000;
            let startTime = null;
            
            function animate(currentTime) {
                if (startTime === null) startTime = currentTime;
                const progress = Math.min((currentTime - startTime) / duration, 1);
                
                if (isNumber) {
                    const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
                    element.textContent = currentValue;
                } else {
                    if (progress === 1) {
                        element.textContent = targetValue;
                    }
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            requestAnimationFrame(animate);
        }

        function formatTokens(tokens) {
            if (tokens < 1000) return tokens.toString();
            if (tokens < 1000000) return (tokens / 1000).toFixed(1) + 'K';
            return (tokens / 1000000).toFixed(1) + 'M';
        }

        // TEST CONNECTION BACKEND
        async function testBackendConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const health = await response.json();
                
                if (health.status) {
                    console.log('âœ… Backend connectÃ©:', health.status);
                    updateConnectionStatus(true);
                }
            } catch (error) {
                console.warn('âš ï¸ Backend non accessible:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(isConnected) {
            const statusCards = document.querySelectorAll('.status-card');
            if (!isConnected) {
                statusCards.forEach(card => {
                    card.style.background = 'linear-gradient(135deg, var(--accent-rose), rgba(236, 72, 153, 0.8))';
                });
                
                const header = document.querySelector('.header');
                const warningDiv = document.createElement('div');
                warningDiv.className = 'error-message';
                warningDiv.innerHTML = `
                    <div class="result-title">
                        <span>âš ï¸</span>
                        <span>Backend non connectÃ©</span>
                    </div>
                    <p>DÃ©marrez le serveur sur ${API_BASE_URL} pour utiliser toutes les fonctionnalitÃ©s</p>
                `;
                header.appendChild(warningDiv);
            }
        }

        // INITIALISATION
        document.addEventListener('DOMContentLoaded', function() {
            createStars();
            createFloatingOrbs();
            testBackendConnection();
            loadStats();
            
            // Message de bienvenue
            setTimeout(() => {
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'success-message';
                welcomeMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1000;
                    max-width: 400px;
                    opacity: 0;
                    transition: opacity 0.5s ease;
                `;
                
                welcomeMessage.innerHTML = `
                    <div class="result-title">
                        <span>ğŸ‰</span>
                        <span>Ã‰tudIA v4.0 ChargÃ© !</span>
                    </div>
                    <p>Interface rÃ©volutionnaire avec OCR rÃ©elle prÃªte ! ğŸš€</p>
                `;
                
                document.body.appendChild(welcomeMessage);
                
                // Animation d'apparition
                setTimeout(() => {
                    welcomeMessage.style.opacity = '1';
                }, 100);
                
                // Disparition
                setTimeout(() => {
                    welcomeMessage.style.opacity = '0';
                    setTimeout(() => {
                        if (document.body.contains(welcomeMessage)) {
                            document.body.removeChild(welcomeMessage);
                        }
                    }, 500);
                }, 4000);
            }, 1000);
            
            console.log(`
ğŸ“ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   âœ¨ Ã‰tudIA v4.0 - INTERFACE RÃ‰VOLUTIONNAIRE CHARGÃ‰E ! âœ¨
   
   ğŸ¨ Design: Ultra-moderne avec effets cosmiques
   ğŸ” OCR: Tesseract.js + PDF-Parse + Mammoth  
   ğŸ¤– IA: Llama 3.3 70B Versatile via Groq
   ğŸ—„ï¸ Base: Supabase PostgreSQL
   ğŸ“¸ Upload: Cloudinary optimisÃ©
   
   ğŸš€ PRÃŠT Ã€ RÃ‰VOLUTIONNER L'Ã‰DUCATION AFRICAINE !
   ğŸ‘¨â€ğŸ’» CrÃ©Ã© avec passion par @Pacousstar
   ğŸ‡¨ğŸ‡® Made with â¤ï¸ in CÃ´te d'Ivoire
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            `);
        });
    </script>
</body>
</html>